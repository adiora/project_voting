<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculate and Store Results</title>
    <!-- Firebase SDK -->
    <script type="module">
        // Importing Firebase app and Firestore modules from Firebase SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAJfrreyoM9E4o8MNJ5kpP5OSmLmoO5JCI",
            authDomain: "project-ideas-ce66a.firebaseapp.com",
            projectId: "project-ideas-ce66a",
            storageBucket: "project-ideas-ce66a.firebasestorage.app",
            messagingSenderId: "508031794242",
            appId: "1:508031794242:web:ab31a43b4644f45c6401db",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Function to calculate and store results
        async function calculateAndStoreResults() {
            try {
                console.log("Processing votes...");

                // Fetch all projects from the 'projects' collection
                const projectsSnapshot = await getDocs(collection(db, "projects"));
                const projects = [];
                projectsSnapshot.forEach(doc => {
                    const projectData = doc.data();
                    projects.push({
                        projectId: doc.id,
                        projectName: projectData.name
                    });
                });

                // Initialize an object to store points for each project
                const projectPoints = {};

                // Fetch all votes from the 'votes' collection
                const votesSnapshot = await getDocs(collection(db, "votes"));

                // Calculate points for each project based on vote rankings
                votesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const firstChoice = data.first;
                    const secondChoice = data.second;
                    const thirdChoice = data.third;

                    if (firstChoice) {
                        projectPoints[firstChoice] = (projectPoints[firstChoice] || 0) + 3;
                    }
                    if (secondChoice) {
                        projectPoints[secondChoice] = (projectPoints[secondChoice] || 0) + 2;
                    }
                    if (thirdChoice) {
                        projectPoints[thirdChoice] = (projectPoints[thirdChoice] || 0) + 1;
                    }
                });

                // Log the points for each project
                for (const projectId in projectPoints) {
                    if (projectPoints.hasOwnProperty(projectId)) {
                        console.log(`${projectId}: ${projectPoints[projectId]} points`);
                    }
                }

                // Store results in the 'result' collection
                // Store results in the 'result' collection
                for (let projectName in projectPoints) {
                    const project = projects.find(proj => proj.projectName === projectName); // Match by projectName

                    if (project) {
                        // Log the project name and points
                        console.log(`${project.projectName}: ${projectPoints[projectName]} points`);

                        // Add result to the 'result' collection
                        await addDoc(collection(db, "result"), {
                            projectId: project.projectId, // Now using the correct projectId
                            projectName: project.projectName,
                            points: projectPoints[projectName]
                        });
                    } else {
                        console.log(`Project with name "${projectName}" not found.`);
                    }
                }


                console.log("Results have been successfully stored in the 'result' collection!");
            } catch (error) {
                console.error("Error calculating and storing results:", error);
            }
        }

        // Wait for DOM content to load before attaching event listener
        window.addEventListener('DOMContentLoaded', () => {
            const calculateBtn = document.getElementById('calculateBtn');
            calculateBtn.addEventListener('click', calculateAndStoreResults);
        });
    </script>
</head>
<body>

    <h1>Vote Calculation</h1>
    <button id="calculateBtn">Calculate & Store Results</button>

</body>
</html>
